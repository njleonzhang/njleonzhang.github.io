---
layout: post
title: ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 2 - æœ€åŸºæœ¬çš„ SSR é¡¹ç›®
date: 2018-07-30
categories: å‰ç«¯
tags: vue SSR
---

> æœ¬æ–‡å¯¹åº”çš„ SSR demo é¡¹ç›®ä»“åº“ä¸º: https://github.com/njleonzhang/play-vue-ssr

[å‰æ–‡](https://njleonzhang.github.io/2018/07/27/vue-ssr-1.html)å¼€å‘ï¼Œç»§ç»­å¡«ï¼ŒğŸ˜‚ã€‚

# æ™®é€šçš„éSSR Vue é¡¹ç›®
å…ˆä»æˆ‘ä»¬ç†Ÿæ‚‰çš„æ™®é€šçš„ vue é¡¹ç›®å‡ºå‘, å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª vue é¡¹ç›®ï¼Œåªæœ‰è¿™ä¸ªä¸€ä¸ª vue å®ç°çš„é¡µé¢:

```
// app.vue
<template>
  <div>
    hello world
    <div v-if='show'>show me</div>
    <div>
      <button @click='toggle'>toggle</button>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      show: true
    }
  },
  methods: {
    toggle() {
      this.show = !this.show
    }
  }
}
</script>
```

ä¸ºäº†è®©è¿™ä¸ªé¡µé¢åœ¨æµè§ˆå™¨é‡Œè·‘èµ·æ¥ï¼Œæˆ‘ä»¬è¦ä¸ºè¿™ä¸ª vue æ–‡ä»¶å†™ä¸€ä¸ªå…¥å£ js æ–‡ä»¶ `main.js`, ä¸€ä¸ª `index.html` æ¨¡æ¿æ–‡ä»¶ å’Œ ä¸€ä¸ª `webpack` é…ç½®æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾:

![default](https://user-images.githubusercontent.com/13174059/43379252-1cb75320-93fe-11e8-8205-41e68b308c71.png)

ç®€å•å®ç°ä¸€ä¸‹è¿™å‡ ä¸ªæ–‡ä»¶:

```
// main.js
import Vue from 'vue'
import App from './App.vue'

new Vue({
  render: h => h(App)
}).$mount('#app')
```

```
// webpack config file

const path = require('path')
const { VueLoaderPlugin } = require('vue-loader')
 const isProd = process.env.NODE_ENV === 'production'
 module.exports = {
  entry: {
    app: './src/entry-client.js'
  },
  output: {
    path: path.resolve(__dirname, '../dist'),
    publicPath: '/dist/',
    filename: 'bundle.js'
  },
  module: {
    rules: [
      {
        test: /\.vue$/,
        loader: 'vue-loader',
      },
      {
        test: /\.js$/,
        loader: 'babel-loader',
        exclude: /node_modules/
      },
    ]
  },
  plugins: [
    new VueLoaderPlugin()
  ],
}
```

è¿™æ · `webpack` ç¼–è¯‘åï¼Œå°±ä¼šç”Ÿæˆ `bundle.js` äº†, ç„¶åæˆ‘ä»¬ç²—æš´åœ°æ¥æ‰‹åŠ¨ `inject` ä¸€ä¸‹ `js`ã€‚

```html
  <!-- index.html -->
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8">
    </head>
    <body>
      <script src='/bundle.js'>
    </body>
  </html>
```

ğŸ‘Œï¼Œç°åœ¨æŠŠè¿™ä¸ª `index.html` æ–‡ä»¶å’Œ `bundle.js` å‘å¸ƒå‡ºå»ï¼Œè¿™ä¸ª demo ç«™å°±å¥½äº†ã€‚

# æ”¹é€ æˆSSR

è¯·å‡ºå¤§ç¥çš„å›¾:

![](https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png)

å¿½ç•¥ `Store` å’Œ `Router`, é‚£ä¹ˆå°¤å¤§çš„è¿™ä¸ªå›¾å’Œæˆ‘ä»¬ä¸Šé¢çš„éSSRç‰ˆæœ¬çš„å›¾çš„ä¸»è¦åŒºåˆ«åœ¨äºä»¥ä¸‹2ç‚¹:

1. ç”Ÿæˆçš„ `bundle.js` æ–‡ä»¶æœ‰2ä¸ª

    è¿™ç‚¹æ¯”è¾ƒå¥½ç†è§£ï¼Œ[å‰æ–‡](2018-7-27-vue-ssr-1.md)ä¸­æˆ‘ä»¬å°±æåˆ°è¿‡: SSR çš„æ¶æ„ä¸­ï¼Œé¡µé¢éœ€è¦åœ¨åå°è¢«æ¸²æŸ“å¥½ç„¶åè¿”å›ç»™å‰å°ï¼Œå†ç”±å‰å°çš„ `bundle js` hydrate åæ¥ç®¡é¡µé¢ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æºç æ—¢éœ€è¦è·‘åœ¨å‰å°ï¼Œä¹Ÿéœ€è¦è·‘åœ¨åå°ã€‚è·‘åœ¨åå°æ—¶ï¼Œå°±æ˜¯è¦è·‘åœ¨ Node ç¯å¢ƒï¼Œè·‘åœ¨å‰å°æ—¶å°±éœ€è¦è·‘åœ¨æµè§ˆå™¨ç¯å¢ƒ, é‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶éœ€è¦æ‰“åŒ…å‡º2ä»½ä¸ä¸€æ ·çš„ bundle js å’¯.

    æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ `webpack` æ–‡ä»¶, ä»¥ç”Ÿæˆ2ä»½ bundleã€‚`client` å’Œé SSR ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶åŸºæœ¬ä¸€è‡´ï¼Œ`server` ç‰ˆçš„é…ç½®æ–‡ä»¶æŒ‡æ˜ç›®æ ‡æ˜¯ node.

    ```
      // webpack.client.config.js
      const config = merge(base, {
        entry: {
          app: './src/entry-client.js'
        },
        output: {
          filename: 'client-bundle.js'
        },
        ....
      )
    ```

    ```
      // webpack.server.config.js
      const config = merge(base, {
        target: 'node',                   // ç›®æ ‡æ˜¯ node
        entry: './src/entry-server.js',
        output: {
          filename: 'server-bundle.js',
          libraryTarget: 'commonjs2'      // ç¼–è¯‘æˆ commonjs
        },
        ....
      )
    ```

2. å’Œ entry ç›¸å…³çš„ js æ–‡ä»¶æœ‰3ä¸ª (app.js, client entry, server entry)

    è¿™ä¸ªé—®é¢˜ç±»ä¼¼äº Vue component çš„ data å±æ€§ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨å‡½æ•°ã€‚å½“å‰çš„ä¾‹å­é‡Œè¿˜æ²¡æœ‰å¼•å…¥ `Store` å’Œ `Route`, æ‰€æœ‰åªä»å½“å‰çš„ä¾‹å­æ¥çœ‹è¿˜ä¸å¤ªå¥½ç†è§£ã€‚æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œæ¯æ¬¡æœ‰ç”¨æˆ·æ¥è®¿é—®æˆ‘ä»¬ç½‘ç«™çš„æ—¶å€™ï¼Œåå°éƒ½ç»™ä»–æ¸²æŸ“ä¸€ä¸ªé¡µé¢ï¼Œå¦‚æœ Node æœåŠ¡å™¨å§‹ç»ˆç”¨ä¸€ä¸ª Vue app å®ä¾‹å»æ¸²æŸ“ï¼Œåˆ™å¾ˆå®¹æ˜“ä¸åŒç”¨æˆ·ä¹‹é—´æ•°æ®ä¸²æ‰çš„é—®é¢˜ï¼Œæ‰€ä»¥ Node æœåŠ¡å™¨è¿™ä¸ª Bundle éœ€è¦æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œæ¯æ¬¡ç”¨æˆ·æ¥è®¿é—®ï¼Œæˆ‘éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„ Vue app å®ä¾‹ï¼Œå¹¶ç”¨è¿™ä¸ªæ–°çš„ï¼Œå¹²å‡€çš„å®ä¾‹å»æ¸²æŸ“é¡µé¢ã€‚

    å°¤å¤§çš„è§£é‡Šå¯èƒ½æ›´æŠ½è±¡ä¸€ç‚¹: **å½“ç¼–å†™çº¯å®¢æˆ·ç«¯(client-only)ä»£ç æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºæ¯æ¬¡åœ¨æ–°çš„ä¸Šä¸‹æ–‡ä¸­å¯¹ä»£ç è¿›è¡Œå–å€¼ã€‚ä½†æ˜¯ï¼ŒNode.js æœåŠ¡å™¨æ˜¯ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„è¿›ç¨‹ã€‚å½“æˆ‘ä»¬çš„ä»£ç è¿›å…¥è¯¥è¿›ç¨‹æ—¶ï¼Œå®ƒå°†è¿›è¡Œä¸€æ¬¡å–å€¼å¹¶ç•™å­˜åœ¨å†…å­˜ä¸­ã€‚è¿™æ„å‘³ç€å¦‚æœåˆ›å»ºä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå®ƒå°†åœ¨æ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ä¹‹é—´å…±äº«ã€‚**

    > å¦‚æœï¼Œä½ æš‚æ—¶ä¸èƒ½ç†è§£åŸå› ï¼Œé‚£ä¹Ÿæ²¡å…³ç³»ï¼Œå…ˆè®°ä½å¥½äº†ï¼ŒNode æœåŠ¡å™¨ç«¯çš„è¿™ä¸ª bundle é‡Œçš„ Vue app éœ€è¦æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•ã€‚åé¢æˆ‘ä»¬è¯´åˆ° Router å’Œ State çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªé—®é¢˜ã€‚

    æˆ‘ä»¬æ”¹é€ é SSRç‰ˆæœ¬çš„ `main.js`, æˆ‘ä»¬æŠ½å–ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œç”¨äºç”Ÿæˆ Vue app çš„å®ä¾‹:

    ```
      // app.js

      import Vue from 'vue'
      import App from './App.vue'
       // å¯¼å‡ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œç”¨äºåˆ›å»ºæ–°çš„
      export function createApp () {
        const app = new Vue({
          // æ ¹å®ä¾‹ç®€å•çš„æ¸²æŸ“åº”ç”¨ç¨‹åºç»„ä»¶ã€‚
          render: h => h(App)
        })
        return { app }
      }
    ```

    å¯¹äºå®¢æˆ·ç«¯çš„ bundleï¼Œæˆ‘ä»¬è¿˜æ˜¯åªéœ€è¦ä¸€ä»½ vue appï¼Œæ‰€ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ª app, ç„¶å mount å°±å¥½. ä»£ç é€»è¾‘å’ŒåŸæ¥é SSR çš„ç‰ˆæœ¬å®é™…ä¸Šæ˜¯ä¸€æ ·çš„ã€‚
    ```
      // entry-client.js

      import { createApp } from './app'
       const { app } = createApp()
       // è¿™é‡Œå‡å®š App.vue æ¨¡æ¿ä¸­æ ¹å…ƒç´ å…·æœ‰ `id="app"`
      app.$mount('#app')
    ```

    å¯¹äºæœåŠ¡å™¨ç‰ˆæœ¬çš„ bundle, æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼š

    ```
      // entry-server.js

      import { createApp } from './app'
       export default context => {
        const { app } = createApp()
        return app
      }
    ```

  è‡³æ­¤ï¼Œè¿™ä¸ªé SSR çš„ vue é¡¹ç›®åˆ° SSR ç‰ˆæœ¬çš„æ”¹é€ åŸºæœ¬å®Œæˆï¼Œæˆ‘ä»¬è¿˜ç¼ºä¸ª Node æœåŠ¡å™¨ç”¨äºåšåå°æ¸²æŸ“ï¼Œå½“ç„¶è¿™ä¸ªæ˜¯ SSR æ¶æ„æ‰€ç‰¹æœ‰çš„ã€‚

# Node æœåŠ¡å™¨

è¿™é‡Œæˆ‘åªæ˜¯æŠŠå°¤å¤§çš„ä¾‹å­ç¨å¾®æ”¹äº†æ”¹:

```
const Vue = require('vue')
const express = require('express')
const server = express()
const createRenderer = require('vue-server-renderer').createRenderer
const app = require('./dist/server-bundle')

const renderer = createRenderer({
  template: require('fs').readFileSync('./index.template.html', 'utf-8'),
})

 server.use(express.static('dist'))  // ä¸ºäº†è®© client-bundle.js èƒ½å¤Ÿè¢«åŠ è½½

 server.get('*', (req, res) => {
  const context = {
    title: 'hello',
    meta: `
      <meta charset="utf8">
    `
  }
   renderer.renderToString(app.default(), context, (err, html) => {
    if (err) {
      res.status(500).end('Internal Server Error')
      return
    }
     res.send(html)
  })
})
 server.listen(8080, () => {
  console.log(`server started at localhost:8080`)
})
```

å¯ä»¥çœ‹åˆ°ç”¨æˆ·å¯¹æˆ‘ä»¬é¡µé¢çš„è®¿é—®ï¼Œä¼šæœ€ç»ˆç”± `renderer.renderToString` åšä¸€æ¬¡æ¸²æŸ“ï¼Œæ¸²æŸ“çš„ç»“æœå°±æ˜¯æˆ‘ä¸€ç›´æåˆ°çš„`çœŸçš„ï¼ˆå®Œæ•´çš„ï¼‰å£³å­html`.è¿™ä¸ªæ¸²æŸ“å‡ºæ¥çš„`å£³å­html`è¢«è¿”å›ç»™å‰å°åï¼Œå®ƒéœ€è¦åŠ è½½ client bundleï¼Œè¿›è€Œè¿›è¡Œ hydrateã€‚æ‰€ä»¥åœ¨è¿™ä¸ªå£³å­é‡Œéœ€è¦æ³¨å…¥ client bundleã€‚ä»ç®€å•é˜è¿°çš„ç›®çš„å‡ºå‘ï¼Œæˆ‘ä¹Ÿæ˜¯åšäº†æš´åŠ›çš„æ‰‹åŠ¨ inject:

{% raw %}
```html
// index.template.html
<html>
  <head>
    <!-- ä½¿ç”¨åŒèŠ±æ‹¬å·(double-mustache)è¿›è¡Œ HTML è½¬ä¹‰æ’å€¼(HTML-escaped interpolation) -->
    <title>{{ title }}</title>

    <!-- ä½¿ç”¨ä¸‰èŠ±æ‹¬å·(triple-mustache)è¿›è¡Œ HTML ä¸è½¬ä¹‰æ’å€¼(non-HTML-escaped interpolation) -->
    {{{ meta }}}
  </head>
  <body>
    <!--vue-ssr-outlet-->
    <script src='/client-bundle.js'></script>  // æš´åŠ› injectã€‚ä¸ºäº†è®©è¿™ä¸ªè¯·æ±‚èƒ½æˆåŠŸ
                                               // node server é‡Œç‰¹åˆ«åŠ äº†ä¸€ä¸ªé™æ€æ–‡ä»¶çš„é…ç½®
                                               // server.use(express.static('dist'))
  </body>
</html>
```
{% endraw %}


# æ•ˆæœ

é¦–å…ˆï¼Œåå°è¿”å›çš„å†…å®¹é‡Œç¡®å®æ˜¯ä¸€ä¸ªå®Œæ•´çš„é¡µé¢ï¼ŒSEO æ— å¿§å•¦ï¼é¦–å±ç™½å±æ— å¿§å•¦ï¼

![](https://user-images.githubusercontent.com/13174059/43384860-da3f3d00-9411-11e8-84c7-69bb928374aa.jpg)

å†çœ‹ä¸€ä¸‹å‰ç«¯ vue æ˜¯å¦æ¥ç®¡äº†é¡µé¢ï¼š

![](https://user-images.githubusercontent.com/13174059/43385126-83e021ee-9412-11e8-8fa8-d4788144992d.gif)

Bingoï¼ï¼ï¼ `@click` å’Œ `v-if` å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

è¯»è€…å¯ä»¥è‡ªå·±å°è¯•ä¸‹ï¼š

```
git clone https://github.com/njleonzhang/play-vue-ssr.git
npm install
git checkout level1
npm run start
```

æˆ–è€…ç›´æ¥çœ‹è¿™ä¸ª[commit](https://github.com/njleonzhang/play-vue-ssr/commit/ba5a0ef80757c2ad00b5095b791ba6f0980e0a27)çš„ä»£ç ã€‚

# æ€»ç»“
æˆ‘ä»¬æ­æ¶äº†ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„ SSR é¡¹ç›®ï¼Œæ²¡æœ‰ Router, æ²¡æœ‰ State, æ²¡æœ‰å„ç§ dev å’Œ pro å¤„ç†ã€‚ä½†æ˜¯æœ‰æ—¶å€™ç®€å•ä¾‹å­å´æœ€èƒ½è¯´æ˜é—®é¢˜çš„æœ¬è´¨ã€‚åé¢çš„å‡ èŠ‚é‡Œï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢åŠ ä¸Š Routerï¼ŒStateï¼Œæ•°æ®é¢„å–ç­‰åŠŸèƒ½ï¼Œå…³äº dev å’Œ pro å¤„ç†ç­‰å·¥ç¨‹åŒ–å®è·µçš„å†…å®¹ä¾ç„¶ä¸ä¼šè®¨è®ºï¼Œå¦‚æœä½ éœ€è¦äº†è§£ç›¸å…³å†…å®¹ï¼Œå¯ä»¥ç›´æ¥å»çœ‹ [Nuxt.js](https://github.com/nuxt/nuxt.js) çš„æ–‡æ¡£ï¼Œ[Nuxt.js](https://github.com/nuxt/nuxt.js) å¯èƒ½æ˜¯ Vue SSR å®é™…å·¥ç¨‹ä½¿ç”¨çš„æœ€ä½³å®è·µã€‚

> ç³»åˆ—æ–‡ç« ï¼š
* [ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 1 - ä¸ºä»€ä¹ˆéœ€è¦ SSR](2018-7-27-vue-ssr-1.md)
* [ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 2 - æœ€åŸºæœ¬çš„ SSR é¡¹ç›®](2018-7-30-vue-ssr-2.md)
* [ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 3 - åŠ å…¥è·¯ç”±æ”¯æŒ](2018-8-4-vue-ssr-3.md)
* [ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 4 - åå°æ•°æ®é¢„æœŸ](2018-8-4-vue-ssr-4.md)
* [ä»é›¶å¼€å§‹æ­å»º Vue SSR DEMO 5 - å¤„ç†å‰å°çš„æ•°æ®åŠ è½½](2018-8-7-vue-ssr-5.md)
