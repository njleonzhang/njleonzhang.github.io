---
layout: post
title: Vue å“åº”å¼åŸç†ç™½è¯ç‰ˆ
date: 2018-09-26
categories: å‰ç«¯
cover: https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/893f05c7-7ee5-e7a8-1cd9-f626ae0425d4.png
tags: vue
---

ä½œä¸ºä¸€ä¸ªå‰ç«¯çš„ MvvM æ¡†æ¶ï¼ŒVue çš„åŸºæœ¬æ€è·¯å’Œ angularã€React å¹¶æ— äºŒè‡´ï¼Œå…¶æ ¸å¿ƒå°±åœ¨äº: å½“æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å»åˆ·æ–°é¡µé¢ Domï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½ä»ç¹ççš„ Dom æ“ä½œä¸­è§£æ”¾å‡ºæ¥ï¼Œä»è€Œä¸“å¿ƒåœ°å»å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚å›æƒ³ä¸€ä¸‹ jQuery æ—¶ä»£çš„ç—›ç‚¹ï¼Œç°åœ¨çš„å‰ç«¯äººçœŸæ˜¯èµ¶ä¸Šäº†å¥½æ—¶ä»£ã€‚ğŸ˜‚ é‚£ä¹ˆ Vue æ˜¯æ€ä¹ˆåšåˆ°è¿™ç§è‡ªåŠ¨æ›´æ–°çš„å‘¢ï¼Ÿ

# å®˜æ–¹çš„ç®€æ˜è§£é‡Š
è¿™ä¸ªé—®é¢˜å³ä¸º Vue çš„å“åº”å¼åŸç†ï¼Œå®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†ä¸€ä¸ªç®€æ´çš„[è§£é‡Š](https://vuejs.org/v2/guide/reactivity.html#ad):

![](https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/abe782d3-2489-c331-582e-3bae2f3b543b.png)

æ€»ç»“ä¸€ä¸‹:

1. ä»»ä½•ä¸€ä¸ª Vue Component éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ Watcher å®ä¾‹ã€‚
2. Vue çš„ `data` ä¸Šçš„å±æ€§ä¼šè¢«æ·»åŠ  getter å’Œ setter å±æ€§ã€‚
3. å½“ Vue Component `render` å‡½æ•°è¢«æ‰§è¡Œçš„æ—¶å€™, `data` ä¸Šä¼šè¢« `è§¦ç¢°(touch)`, å³è¢«`è¯»`, `getter` æ–¹æ³•ä¼šè¢«è°ƒç”¨, æ­¤æ—¶ Vue ä¼šå»è®°å½•æ­¤ Vue component æ‰€ä¾èµ–çš„æ‰€æœ‰ `data`ã€‚(è¿™ä¸€è¿‡ç¨‹è¢«ç§°ä¸ºä¾èµ–æ”¶é›†)
4. `data` è¢«æ”¹åŠ¨æ—¶ï¼ˆä¸»è¦æ˜¯ç”¨æˆ·æ“ä½œï¼‰, å³è¢«`å†™`, `setter` æ–¹æ³•ä¼šè¢«è°ƒç”¨, æ­¤æ—¶ Vue ä¼šå»é€šçŸ¥æ‰€æœ‰ä¾èµ–äºæ­¤ `data` çš„ç»„ä»¶å»è°ƒç”¨ä»–ä»¬çš„ render å‡½æ•°è¿›è¡Œæ›´æ–°ã€‚

å›¾ä¸­çš„è¯´æ³•è‡ªç„¶æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æ²¡æœ‰æ¶‰åŠå¤ªå¤šçš„ç»†èŠ‚ã€‚å¦å¤–è¿˜æœ‰å¤§é‡çš„æ–‡ç« ä»æºç çš„è§’åº¦å»æ·±å…¥çš„æ¢è®¨äº†æ•´ä¸ª Vue å“åº”å¼çš„å®ç°ã€‚æ¯”å¦‚: [Vue.js æŠ€æœ¯æ­ç§˜](https://ustbhuangyi.github.io/vue-analysis/reactive/)ã€[æ·±å…¥è§£æVueä¾èµ–æ”¶é›†åŸç†
](https://www.ruphi.cn/archives/336/). è¿™äº›æ–‡ç« å¾ˆæ˜¯å…·ä½“ï¼Œä½†è¿™ä¸ªå®ç°å¤©ç”Ÿæ¯”è¾ƒå¤æ‚ï¼Œä¸æ˜¯å¾ˆå®¹æ˜“ç†è§£ã€‚æœ¬ç¯‡ä¼šå°è¯•å»é™¤å¤§éƒ¨åˆ†ç»†ææœ«èŠ‚, åªä»‹ç»ä¸€ä¸‹å®ç°æ–¹æ¡ˆçš„å…³é”®ã€‚


äºŒè¯ä¸è¯´ï¼Œå…ˆç›—ç”¨ [Vue.js æŠ€æœ¯æ­ç§˜](https://ustbhuangyi.github.io/vue-analysis/reactive/) é‡Œçš„å›¾:

![](https://ustbhuangyi.github.io/vue-analysis/assets/new-vue.png)

è¿™ä¸ªå›¾å±•ç¤ºäº† Vue.js æ˜¯å¦‚ä½•å°†ä¸€ä¸ª Vue å¯¹è±¡æœ€ç»ˆæ¸²æŸ“æˆé¡µé¢ä¸Šçš„ html DOMçš„ã€‚

## data çš„ reactive åŒ–
 åœ¨ `init` é˜¶æ®µ(defineReactive), Vue å¯¹è±¡å±æ€§ **data çš„å±æ€§**ä¼šè¢« reactive åŒ–ï¼Œå³ä¼šè¢«è®¾ç½® `getter` å’Œ `setter` å‡½æ•°ã€‚

  ```
  function defineReactive(obj: Object, key: string, ...) {
    const dep = new Dep()

    Object.defineProperty(obj, key, {
      enumerable: true,
      configurable: true,
      get: function reactiveGetter () {
        ....
        dep.depend()
        return value
        ....
      },
      set: function reactiveSetter (newVal) {
        ...
        val = newVal
        dep.notify()
        ...
      }
    })
  }
  ```

è¿™ä¸ªå‡½æ•°é‡Œ new äº†ä¸€ä¸ª Dep å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„ç”¨æ³•å¾ˆç‰¹åˆ«ã€‚Vue åœ¨å¯¹ `data` ä¸Šçš„ä»»ä½•ä¸€ä¸ªå±æ€§è¿›è¡Œ reactive åŒ–çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨ `defineReactive` å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´**å¯¹äºæ‰€æœ‰è¢« Vue reactive åŒ–çš„å±æ€§æ¥è¯´éƒ½æœ‰ä¸€ä¸ª Dep å¯¹è±¡ä¸ä¹‹å¯¹åº”**ã€‚é‚£ä¹ˆè¿™ä¸ª Dep æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿå…ˆæŒ–ä¸ªå‘ï¼Œæˆ‘ä»¬ä¸‹é¢å†è¯´ã€‚

æ­¤æ—¶ getter å’Œ setter å‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œ, ä»–ä»¬åªæ˜¯è¢«ç»‘å®šåœ¨äº† `data` çš„å±æ€§ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä¸çœ‹ getter å’Œ setting å‡½æ•°é‡Œçš„å†…å®¹ã€‚

> æ³¨æ„æˆ‘ä»¬å¾—åˆ°çš„è¿™ä¸ªå…³é”®çš„ç»“è®º: **æ‰€æœ‰è¢« Vue reactive åŒ–çš„å±æ€§éƒ½æœ‰ä¸€ä¸ª Dep å¯¹è±¡ä¸ä¹‹å¯¹åº”**

## Watcher çš„åˆ›å»º

Vue å¯¹è±¡ init åä¼šè¿›å…¥ mount é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µçš„å…³é”®ä¸€ä¸ªå‡½æ•°å°±æ˜¯ `mountComponent`:

  ```
  mountComponent(vm: Component, el: ?Element, ...) {
    vm.$el = el

    ...

    updateComponent = () => {
      vm._update(vm._render(), ...)
    }

    new Watcher(vm, updateComponent, ...)
    ...
  }
  ```

è¿™é‡Œçš„ `Watcher` çš„ç”¨æ³•å’Œä¸Šé¢çš„ `Dep` ç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ²¡å¤´æ²¡è„‘çš„è¢« new äº†å‡ºæ¥ğŸ˜‚ ã€‚å¯¹äºæ¯ä¸ª Vue ç»„ä»¶å®ä¾‹æ¥è¯´ï¼Œåªä¼šç»å†ä¸€æ¬¡ mountï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸€ä¸ª Vue å®ä¾‹æ¥è¯´éƒ½æœ‰ä¸€ä¸ª Watcher ä¸ä¹‹å¯¹åº”ï¼ˆ[å®˜æ–¹çš„ç®€æ˜è§£é‡Š](#å®˜æ–¹çš„ç®€æ˜è§£é‡Š)é‡Œçš„ç¬¬ 1 ç‚¹ï¼‰ï¼Œå½“ç„¶å°±æ˜¯ mountComponent é‡Œ new å‡ºæ¥çš„è¿™ä¸ªã€‚ä½†æ˜¯è¿™ä¸ª Vue ç»„ä»¶çš„å¯¹è±¡ä¸Šå¹¶æ²¡æœ‰å­˜è¿™ä¸ª Watcher å®ä¾‹ã€‚æ‰€ä»¥ Vue ç»„ä»¶çš„å®ä¾‹å¹¶ä¸çŸ¥é“è¿™ä¸ª watcher çš„å­˜åœ¨ã€‚

é‚£ä¹ˆåè¿‡æ¥å‘¢ï¼ŸWatcher æ˜¯çŸ¥é“è‡ªå·±æ˜¯å’Œå“ªä¸ª Vue ç»„ä»¶å®ä¾‹ç»‘å®šçš„ï¼Œè¿™ç‚¹æˆ‘ä»¬ä»å…¶æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºæ¥: è¿™ä¸ªæ„é€ æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ Vue component çš„å®ä¾‹ã€‚ç¬¬äºŒä¸ªå‚æ•°å‘¢ï¼Ÿè¿™é‡Œæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°é‡Œè°ƒç”¨äº† `vm._render` å’Œ `vm._update `ã€‚

* `vm._render` çš„ä½œç”¨ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæŠŠ Vue å¯¹è±¡æ¸²æŸ“æˆè™šæ‹Ÿ Dom çš„è¿‡ç¨‹ã€‚
* `vm._update` æ–¹æ³•ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ ¹æ®è™šæ‹Ÿ Dom å»åˆ›å»ºæˆ–æ›´æ–°çœŸæ˜¯ Dom çš„è¿‡ç¨‹ã€‚

æ‰€ä»¥ `Watcher` æ„é€ å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå°±æ˜¯ä¸€ä¸ª Vue å®ä¾‹åˆ·æ–°é¡µé¢ Dom çš„å‡½æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç»„ä»¶çš„ `æ›´æ–°å‡½æ•°` å§ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ `Watcher` çš„å…·ä½“ç»“æ„:

![](https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/b40280c0-131d-7806-1da3-429a9e77f4d3.png)

* `vm` å±æ€§å°±æ˜¯ç»„ä»¶çš„å®ä¾‹
* `getter` å±æ€§å°±æ˜¯ç»„ä»¶çš„ `æ›´æ–°å‡½æ•°`
* `update` å‡½æ•°å¯ä»¥ç†è§£æˆæ˜¯è°ƒç”¨ `æ›´æ–°å‡½æ•°` çš„ä¸€ä¸ªå°è£…ã€‚

> å½“ç„¶ Watcher æœ‰å¤šç§ï¼Œæˆ‘ä»¬åªè®¨è®ºæ˜¯æ¸²æŸ“ Watcher, ä¹Ÿåªåˆ—ä¸¾äº†æˆ‘ä»¬æ¶‰åŠçš„å‡ ä¸ªå±æ€§

çœ‹åˆ°è¿™äº›å±æ€§ï¼Œå†åŠ ä¸Šåå­— `Watcher`, æˆ‘ä»¬ä¹ŸåŸºæœ¬èƒ½çŒœåˆ°è¿™ä¸ª `Watcher` å¯¹è±¡çš„ä½œç”¨äº†å§ã€‚å®ƒä¸ Vue ç»„ä»¶å¯¹è±¡ä¸€ä¸€å¯¹åº”ï¼Œç»„ä»¶éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œ`Watcher` çš„ `run` æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œè¿›è€Œæ›´æ–°é¡µé¢ã€‚**`Watcher`, çœ‹å®ˆäºº, å“¨å…µï¼Œå®ƒç¡®è®¤æ˜¯åƒå“¨å…µä¸€æ ·åœ¨ç­‰å¾…ç€æ›´æ–°é¡µé¢çš„ä¿¡å·**ã€‚é‚£ä¹ˆè¿™ä¸ªä¿¡å·æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå†æŒ–ä¸ªå‘ï¼Œæˆ‘ä»¬ä¸‹é¢å†è¯´ã€‚

## ä¾èµ–æ”¶é›†
Vue çš„å¥‡å¦™æ—…ç¨‹å¼€å§‹äº†ã€‚èµ·ç‚¹å°±æ˜¯ä¸Šé¢æåˆ°çš„è¿™ä¸ª Watcher çš„æ„é€ å‡½æ•°è°ƒç”¨ã€‚ä¸€èˆ¬æ¥è¯´æ„é€ å‡½æ•°é‡Œä¸å¤ªä¼šå»åšå‡ºäº†åˆå§‹åŒ–ä»¥å¤–çš„ä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯ Vue çš„æºç é‡Œ, ä¼¼ä¹å¤„å¤„éƒ½æ˜¯**å¥‡å¥‡æ€ªæ€ª**çš„åšæ³•ğŸ˜‚ï¼Œæ­¤å¤„ä¹Ÿæ˜¯å¦‚æ­¤:

```
class Watcher {
  getter: Function;

  // ä»£ç ç»è¿‡ç®€åŒ–
  constructor(vm: Component, expOrFn: string | Function, ...) {
    ...
    this.getter = expOrFn
    Dep.target = this                      // æš‚ä¸”ä¸ç®¡
    this.value = this.getter.call(vm, vm)  // è°ƒç”¨ç»„ä»¶çš„æ›´æ–°å‡½æ•°
    ...
  }
}
```

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸Šé¢çš„ `new Watcher(vm, updateComponent, ...)` çš„è°ƒç”¨ï¼Œåœ¨ Watcher é‡Œï¼Œä¸ä»…ä»…åˆ›å»ºäº† Watcher çš„å®ä¾‹ï¼Œè¿˜ `å·å·æ‘¸æ‘¸` çš„åšäº†ä¸€ä»¶äº‹ï¼Œå³: è°ƒç”¨äº† vue ç»„ä»¶çš„`æ›´æ–°å‡½æ•°`, `updateComponent`ã€‚è¿™ä¼šå¯¼è‡´ç»„ä»¶çš„æ¸²æŸ“å‡½æ•° `vm._render` è¢«è°ƒç”¨ã€‚æˆ‘ä»¬çŸ¥é“ [æ¸²æŸ“å‡½æ•°](https://cn.vuejs.org/v2/guide/render-function.html) æ˜¯ Vue template è½¬æ¢æ¥çš„ (å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™)ã€‚å¦‚æœä¸è®°å¾—æ€ä¹ˆè½¬çš„äº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å®˜ç½‘ä¸Šçš„è¿™ä¸ªä¾‹å­ï¼š

{% raw %}

```
<template>
  <h1>{{ blogTitle }}</h1>
</template>

<script>
  export default {
    data() {
      return {
        blogTitle: "leon's blog",
        author: 'leon'
      }
    }
  }
</script>

-->

render: function (createElement) {
  return createElement('h1', this.blogTitle)
}
```
{% endraw %}

ä¸éš¾å‘ç°æ¸²æŸ“å‡½æ•°çš„è°ƒç”¨ä¼šå¯¼è‡´**æ¨¡æ¿é‡Œæ¶‰åŠçš„å±æ€§**çš„è¢«è®¿é—®ï¼ˆä¸Šä¾‹ä¸­çš„ `blogTitle`ï¼‰ã€‚è¿™å°±å’Œ[å®˜æ–¹çš„ç®€æ˜è§£é‡Š](#å®˜æ–¹çš„ç®€æ˜è§£é‡Š)é‡Œçš„ç¬¬ 3 ç‚¹å¯¹ä¸Šäº†ã€‚è¿™ä¸ªè®¿é—®å®ƒä¼šå¯¼è‡´çš„è¿™ä¸ªå±æ€§çš„ `getter` å‡½æ•°ï¼ˆreactive åŒ–æ—¶è¢«è®¾ç½®çš„ï¼‰è¢«è°ƒç”¨. æˆ‘ä»¬çœ‹ä¸€ä¸‹ getter å‡½æ•°çš„å®šä¹‰ï¼š

```
function defineReactive(obj: Object, key: string, ...) {
  const dep = new Dep()

  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      ....
      dep.depend()
      return value
      ....
    },
    ...
  })
}
```

è¿™é‡Œçš„å…³é”®ä¹‹å¤„å°±åœ¨äºè°ƒç”¨äº† `dep.depend()`. å‰é¢çš„åˆ†ææˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ**æ‰€æœ‰è¢« Vue reactive åŒ–çš„å±æ€§éƒ½æœ‰ä¸€ä¸ª Dep å¯¹è±¡ä¸ä¹‹å¯¹åº”**ã€‚è¿™é‡Œæˆ‘ä»¬ä¸å¾—ä¸ä»”ç»†çœ‹ä¸€ä¸‹ `Dep` çš„ç»“æ„äº†:

```
class Dep {
  static target: ?Watcher;
  subs: Array<Watcher>;

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}
```

æˆ‘çœ‹å¯ä»¥çœ‹åˆ° Dep æ˜¯è§‚å¯Ÿè€…æ¨¡å¼é‡Œçš„ä¸€ä¸ª Observable æœ‰ä¸€ä¸ª Watcher çš„é˜Ÿåˆ—ï¼Œè€Œè§‚å¯Ÿè€…æ˜¯ Watcher. æˆ‘ä»¬çŸ¥é“ `Dep` ä¸ **Vue reactive åŒ–çš„å±æ€§** å¯¹åº”, è€Œ Watcher ä¸ Vue ç»„ä»¶æ¢³ç†å¯¹åº”ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ Dep, Dep æ˜¯ä¸€ä¸ª **è´¦å•**, ä»–è®°å½•äº†æ‰€æœ‰ä¾èµ–äºè¿™ä¸ªå±æ€§çš„ Vue ç»„ä»¶ï¼Œä¸€æ—¦å‘ç”ŸæŸä¸ªæ—¶é—´ä¹‹åï¼Œåˆ™ä¼šé€šçŸ¥ **è´¦å•** ä¸Šçš„æ‰€æœ‰ Vue ç»„ä»¶å»åˆ·æ–°ï¼ˆå› ä¸ºè°ƒç”¨çš„æ˜¯ Watcher çš„ update æ–¹æ³•ï¼‰ã€‚

è¯´åˆ°è¿™äº†ï¼Œå‰é¢çš„é€»è¾‘æœ‰ç‚¹é•¿äº†ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹:

1. Vue init é˜¶æ®µï¼Œå¯¹æ‰€æœ‰çš„å±æ€§åšäº† reactive åŒ–ï¼Œä¸ºæ¯ä¸€ä¸ªå±æ€§ç»‘å®šäº† getter å‡½æ•°, setter å‡½æ•°ä»¥åŠä¸€ä¸ª Dep å¯¹è±¡ã€‚
2. Vue ç»„ä»¶ mount é˜¶æ®µé‡Œè°ƒç”¨äº† mountComponentæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­ä¸º Vue ç»„ä»¶åˆ›å»ºäº†ä¸€ä¸ª Watcher å¯¹è±¡ã€‚
3. Watcher å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œé¡ºå¸¦æ‰§è¡Œäº† Vue çš„æ›´æ–°å‡½æ•°ï¼Œè¿™è§¦å‘äº† **Vue reactive åŒ–çš„å±æ€§** çš„ get æ–¹æ³•, å¹¶è°ƒç”¨äº† `dep.depend()`ã€‚

å¥½çš„ï¼Œé‚£ä¹ˆ depend è¿™ä¸ªå‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿä»å®šä¹‰ä¸Šçœ‹æˆ‘ä»¬çŸ¥é“ `Dep.target` æ˜¯ä¸€ä¸ª Watcher, åœ¨ `dep.depend()` è¢«è°ƒç”¨, ç„¶å `Dep.target.addDep(this)` è¢«æ‰§è¡Œçš„æ—¶å€™, æ­¤æ—¶ `Dep.target` æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯å½“å‰åˆ›å»ºçš„è¿™ä¸ª Watcher, å³å½“å‰ mount çš„ Vue ç»„ä»¶å¯¹è±¡å¯¹åº”çš„ Watcherã€‚ä¸ºä»€ä¹ˆï¼Ÿæ³¨æ„çœ‹ä¸Šé¢ Watcher æ„é€ å‡½æ•°é‡Œçš„ä»£ç , åœ¨æ‰§è¡Œ Vue ç»„ä»¶çš„æ›´æ–°å‡½æ•°å‰, æœ‰è¿™ä¹ˆä¸€å¥æˆ‘ä»¬æ²¡æœ‰è§£é‡Š, å³ `Dep.target = this`. è¿™å°±æ˜¯äº†, å½“å‰çš„ Watcher è¢«é¢„å…ˆèµ‹ç»™äº† `Dep.target`ã€‚

ææ¸…æ¥šäº†è¿™ä¸ªé—®é¢˜åï¼Œæˆ‘ä»¬çŸ¥é“äº† `dep.depend()` å°±ç­‰ä»·äºæ‰§è¡Œäº†å½“å‰ Watcher å¯¹åº”çš„ addDep æ–¹æ³•, å‚æ•°ä¸ºè¿™ä¸ª reactive å±æ€§å¯¹åº”çš„ Dep å®ä¾‹. Watcher çš„ `addDep` æ–¹æ³•çš„ä»£ç ç®€åŒ–åï¼Œå¤§è‡´å¦‚ä¸‹:

```
class Watcher {
  addDep (dep: Dep) {
    ...
    this.newDeps.push(dep)
    dep.addSub(this)
    ...
  }
}

class Dep {
  addSub (sub: Watcher) {
    this.subs.push(sub)
  }
}
```

`Watcher` çš„ `addDep` æ–¹æ³•ä¸­, `Watcher` æŠŠè¿™ä¸ª `dep` å¯¹è±¡å­˜äº†ä¸‹æ¥(è¿™ä¸ªè‡ªç„¶æ˜¯åˆ«æœ‰ç”¨å¤„ï¼Œæˆ‘ä»¬å°±ä¸è®¨è®ºäº†)ï¼Œç„¶ååæ‰‹åˆè°ƒç”¨äº†, `dep` çš„ `addSub` æ–¹æ³•ï¼Œä¸€ä¸ªæ™®é€šçš„è§‚å¯Ÿè€… subscribe æ–¹æ³•ã€‚

ç»è¿‡äº†è¿™äº›æ­¥éª¤ï¼Œ`dep.depend()` ç»ˆäºè¿™ä¸ª `Watcher` è®°åˆ°äº†è‡ªå·±çš„è´¦æœ¬ä¸­äº†ã€‚

è¿™å°±æ˜¯ Vue ä¾èµ–æ”¶é›†çš„å¤§è‡´æ­¥éª¤äº†ã€‚

## æ´¾å‘æ›´æ–°
æˆ‘ä»¬çŸ¥é“å½“æˆ‘ä»¬æ”¹å˜ä¸€ä¸ª **Vue reactive åŒ–çš„å±æ€§** æ–¹æ³•çš„æ—¶å€™, é¡µé¢ä¼šå¾—åˆ°åˆ·æ–°, å³å’Œè¿™ä¸ªå±æ€§ç›¸å…³çš„ Vue ç»„ä»¶çš„æ›´æ–°å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚æœ‰äº†ä¸Šé¢çš„ä¾èµ–æ”¶é›†ï¼Œè¿™ä¸€æ­¥å…¶å®å°±éå¸¸ç®€å•äº†ï¼Œä¿®æ”¹ **Vue reactive åŒ–çš„å±æ€§** å°±ä¼šè°ƒç”¨å…¶ setter æ–¹æ³•, æˆ‘å†çœ‹ä¸€çœ¼å®ƒçš„å®šä¹‰:

```
function defineReactive(obj: Object, key: string, ...) {
  const dep = new Dep()

  Object.defineProperty(obj, key, {
    ...
    set: function reactiveSetter (newVal) {
      ...
      val = newVal
      dep.notify()
      ...
    }
  })
}
```

ç›´æ¥è°ƒç”¨ dep çš„ `notify`, è¿™ä¸ªæ–¹æ³•çš„ä»£ç æˆ‘ä»¬ä¸Šé¢è´´è¿‡äº†ï¼Œå°±æ˜¯ä¾æ¬¡å»è°ƒç”¨æ‰€æœ‰ä¾èµ–è¿™ä¸ªå±æ€§çš„æ‰€æœ‰çš„ Vue ç»„ä»¶çš„æ›´æ–°å‡½æ•°ã€‚

![](https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/893f05c7-7ee5-e7a8-1cd9-f626ae0425d4.png)

è¿™ä¸ªæ›´æ–°æ´¾å‘çš„è¿‡ç¨‹å¤§è‡´å¯ä»¥è¡¨ç¤ºæˆä¸Šå›¾çš„æ ·å­ï¼Œä»å›¾ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ(render) Watcher å’Œ Vue ç»„ä»¶å®ä¾‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œreactive åŒ–çš„å±æ€§å’Œ Dep å®ä¾‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚

æˆ‘ä»¬å†å€Ÿä¸€å¼ [xingbofeng](https://github.com/xingbofeng/xingbofeng.github.io/issues/15)çš„å›¾ï¼Œæ¥æè¿°æ•´ä¸ªè¿‡ç¨‹ï¼Œå¤§å®¶çœ‹çœ‹æ˜¯å¦èƒ½ç†è§£:

![](https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/7d769e58-03f7-a633-121e-0133c47487fa.png)

å…³äºæ›´è¯¦ç»†çš„å®ç°ç»†èŠ‚ï¼Œæˆ‘è¿™é‡Œä¹Ÿå¼•ç”¨[RuphiLau](https://www.ruphi.cn/archives/336/) çš„ä¸€å¼ å›¾, æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚çœ‹åæ–‡è´´å‡ºçš„å‚è€ƒæ–‡æ¡£ã€‚

![](https://raw.githubusercontent.com/njleonzhang/image-bed/master/assets/1cc9c79c-86af-8a2d-dddd-82bd309eaf44.png)

## ç°å®çš„é—®é¢˜
äº†è§£äº†çš„ Vue å“åº”å¼åŸç†ä¹‹åï¼Œæˆ‘ä»¬å¯èƒ½å°±èƒ½å¤Ÿæ›´æ¸…æ¥šçš„ç†è§£ä¸€äº›ç°å®çš„é—®é¢˜äº†, æ¯”å¦‚:

```
var vm = new Vue({
  data:{
    a:1
  }
})

// `vm.a` æ˜¯å“åº”çš„

vm.b = 2
// `vm.b` æ˜¯éå“åº”çš„
```
æˆ‘ä»¬çŸ¥é“å±æ€§ `b` æ˜¯éå“åº”çš„, å®˜ç½‘ä¹Ÿè¯´äº†åŸå› : **ç”±äº Vue ä¼šåœ¨åˆå§‹åŒ–å®ä¾‹æ—¶å¯¹å±æ€§æ‰§è¡Œ getter/setter è½¬åŒ–è¿‡ç¨‹**, è¿™ä¸ªè½¬åŒ–å°±æ˜¯åœ¨ä¸Šæ–‡ä»‹ç»çš„ `defineReactive` å‡½æ•°é‡Œå®æ–½çš„ã€‚

```
var vm = new Vue({
  data: {
    items: ['a', 'b', 'c']
  }
})

vm.items[1] = 'x' // ä¸æ˜¯å“åº”æ€§çš„
vm.items.length = 2 // ä¸æ˜¯å“åº”æ€§çš„
```

items é¡¹æ˜¯æ•°ç»„ï¼Œæ•°ç»„çš„ç´¢å¼•å¹¶ä¸æ˜¯å±æ€§ï¼Œä¹Ÿå¾ˆéš¾ç”¨ Dep å»ç»‘å®šï¼Œæ‰€ä»¥ Vue æ²¡æœ‰å¤„ç†; æ•°ç»„çš„é•¿åº¦è™½ç„¶æ˜¯å±æ€§ï¼Œä¹Ÿèƒ½å¤Ÿé€šè¿‡ defineProperty å¤„ç†ï¼Œä½†å°¤å¤§å¯èƒ½è§‰å¾—å®ƒå¾ˆç‰¹åˆ«ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰å¤„ç†ã€‚è¿™å°±å¯¼è‡´äº†ç°åœ¨çš„æƒ…å†µã€‚

å½“ç„¶ï¼Œå°¤å¤§ç»™æˆ‘ä»¬æä¾›äº†å˜é€šçš„æ–¹æ¡ˆ:

```
vm.items.splice(indexOfItem, 1, newValue)
vm.items.splice(newLength)
```

å‚è€ƒæ–‡ç« :
* https://ustbhuangyi.github.io/vue-analysis/reactive/
* https://www.ruphi.cn/archives/336/
* https://github.com/xingbofeng/xingbofeng.github.io/issues/15
* https://github.com/muwenzi/Program-Blog/issues/83
